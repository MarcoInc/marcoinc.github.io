<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dado Personalizzato</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f8f9fa; --card:#fff; --text:#212529; --muted:#6c757d; --btn-bg:#0d6efd; --btn-text:#fff;
    }
    .dark{ --bg:#0b1020; --card:#0f1724; --text:#e6eef8; --muted:#9aa7bf; --btn-bg:#375a7f; --btn-text:#fff; }
    .green{ --bg:#e9f6ec; --card:#d7f0db; --text:#062b10; --muted:#3c5d43; --btn-bg:#62bd5b; --btn-text:#fff; }
    .blue{ --bg:#e8f0fa; --card:#d4e4f5; --text:#0b1e34; --muted:#3a5575; --btn-bg:#2196f3; --btn-text:#fff; }
    .red{ --bg:#fbe9e9; --card:#f3d1d1; --text:#2a0b0b; --muted:#703d3d; --btn-bg:#f44336; --btn-text:#fff; }

    body{ font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); transition:background .3s,color .3s; }
    .app-card{ background:var(--card); box-shadow:0 4px 16px rgba(0,0,0,0.1); border-radius:12px; color:var(--text); }
    .btn-custom{ background:var(--btn-bg); color:var(--btn-text); border:none; }
    .die{ width:220px; height:220px; display:flex; align-items:center; justify-content:center; border-radius:18px; font-weight:700; font-size:22px; text-align:center; padding:18px; }
    .die .face-text{ font-size:26px; font-weight:800; }
    .rolling{ animation:roll 900ms ease-in-out; }
    @keyframes roll{ 0%{ transform:rotate(0) scale(1);} 50%{ transform:rotate(180deg) scale(1.08);} 100%{ transform:rotate(360deg) scale(1);} }
    .no-faces{ opacity:0.7; }
    .confetti-canvas{ position:fixed; left:0; top:0; width:100%; height:100%; pointer-events:none; z-index:1050; }
    .face-box{ position:relative; padding:10px; border-radius:10px; font-weight:600; text-align:center; cursor:pointer; }
    .face-box .remove-btn{ position:absolute; top:4px; right:6px; background:rgba(0,0,0,0.6); color:#fff; border:none; border-radius:50%; width:20px; height:20px; font-size:12px; line-height:18px; cursor:pointer; }
  </style>
</head>
<body>
  <canvas id="confetti-canvas" class="confetti-canvas"></canvas>

  <div class="container py-4">
    <!-- Header e Tema -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="h3 mb-0">Dado personalizzato</h1>
      <div class="d-flex gap-2">
        <select id="themeSelect" class="form-select form-select-sm">
          <option value="">Chiaro</option>
          <option value="dark">Scuro</option>
          <option value="green">Verde</option>
          <option value="blue">Blu</option>
          <option value="red">Rosso</option>
        </select>
      </div>
    </div>

    <!-- Domanda personalizzata -->
    <div class="mb-3">
      <label class="form-label">Domanda personalizzata</label>
      <input type="text" id="questionInput" class="form-control" placeholder="A chi tocca?">
    </div>

    <div class="row g-4">
      <!-- Colonna Dado + Statistiche -->
      <div class="col-lg-6">
        <div class="p-4 app-card text-center">
          <div id="die" class="die app-card mb-3">
            <div class="face-text" id="dieText">Nessuna faccia</div>
          </div>
          <button id="rollBtn" class="btn btn-custom btn-lg">🎲 Estrai</button>
          <div class="mt-3 small">Totale estrazioni: <span id="totalDraws">0</span> — Ultima: <span id="lastDraw">—</span></div>
        </div>

        <div class="mt-3 p-3 app-card">
          <h5>Statistiche</h5>
          <canvas id="statsChart" style="max-height:260px;"></canvas>
        </div>
      </div>

      <!-- Colonna Facce -->
      <div class="col-lg-6">
        <div class="p-3 app-card">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5>Facce</h5>
            <button class="btn btn-custom btn-sm" id="addFaceBtn">+ Aggiungi faccia</button>
          </div>
          <div id="facesGrid" class="row g-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Aggiungi/Modifica Faccia -->
  <div class="modal fade" id="faceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content app-card">
        <div class="modal-header">
          <h5 class="modal-title" id="faceModalLabel">Aggiungi faccia</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <form id="faceForm">
            <input type="hidden" id="faceId">
            <div class="mb-3">
              <label class="form-label">Nome</label>
              <input type="text" id="faceName" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Emoji (opzionale)</label>
              <input type="text" id="faceEmoji" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">Colore preset</label>
              <select id="faceColor" class="form-select">
                <option value="#ffd54f">Giallo</option>
                <option value="#90caf9">Azzurro</option>
                <option value="#f48fb1">Rosa</option>
                <option value="#62bd5b">Verde</option>
                <option value="#ce93d8">Viola</option>
                <option value="#ffab91">Arancio</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Effetto speciale</label>
              <select id="faceEffect" class="form-select">
                <option value="confetti">Coriandoli</option>
                <option value="fireworks">Fuochi d'artificio</option>
                <option value="stars">Stelline</option>
                <option value="sparkles">Scie luminose</option>
                <option value="bubbles">Bollicine</option>
                <option value="smoke">Fumo colorato</option>
                <option value="ribbons">Nastri colorati</option>
                <option value="hearts">Cuoricini</option>

              </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
          <button type="button" class="btn btn-primary" id="saveFaceBtn">Salva</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script>
const LS_FACES='dado_faces_v5';
const LS_STATS='dado_stats_v5';
const LS_SETTINGS='dado_settings_v5';
const LS_QUESTION='dado_question_v5';

const facesGrid=document.getElementById('facesGrid');
const dieText=document.getElementById('dieText');
const rollBtn=document.getElementById('rollBtn');
const addFaceBtn=document.getElementById('addFaceBtn');
const saveFaceBtn=document.getElementById('saveFaceBtn');
const faceModal=new bootstrap.Modal(document.getElementById('faceModal'));
const questionInput=document.getElementById('questionInput');
const themeSelect=document.getElementById('themeSelect');
const totalDrawsEl=document.getElementById('totalDraws');
const lastDrawEl=document.getElementById('lastDraw');
const statsChartCtx=document.getElementById('statsChart').getContext('2d');

let faces=[];
let stats={ total:0, counts:{} };
let settings={ theme:'' };
let statsChart;

// Load data from localStorage
function load(){
    const f=localStorage.getItem(LS_FACES); if(f) faces=JSON.parse(f);
    const s=localStorage.getItem(LS_STATS); if(s) stats=JSON.parse(s);
    const sett=localStorage.getItem(LS_SETTINGS); if(sett) settings=JSON.parse(sett);
    const q=localStorage.getItem(LS_QUESTION); if(q) questionInput.value=q;
    applyTheme();
    renderFaces();
    updateStatsUI();
    initChart();
}

// Save data
function saveFaces(){ localStorage.setItem(LS_FACES,JSON.stringify(faces)); }
function saveStats(){ localStorage.setItem(LS_STATS,JSON.stringify(stats)); }
function saveSettings(){ localStorage.setItem(LS_SETTINGS,JSON.stringify(settings)); }
function saveQuestion(){ localStorage.setItem(LS_QUESTION,questionInput.value); }

// Render faces grid
function renderFaces(){
    facesGrid.innerHTML='';
    if(faces.length===0){
        facesGrid.innerHTML='<div class="col-12 text-center p-4 no-faces">Nessuna faccia</div>';
        dieText.innerText='Nessuna faccia';
        return;
    }
    faces.forEach((f,idx)=>{
        const col=document.createElement('div'); col.className='col-6 col-md-4';
        col.innerHTML=`<div class="face-box" style="background:${f.color};color:${getContrastColor(f.color)};">${f.emoji||''} ${f.name}<button class="remove-btn" data-idx="${idx}">×</button></div>`;
        facesGrid.appendChild(col);
    });
    document.querySelectorAll('.remove-btn').forEach(btn=>{
        btn.addEventListener('click',e=>{
            const idx=Number(e.target.dataset.idx);
            faces.splice(idx,1);
            saveFaces();
            renderFaces();
            updateChart();
        });
    });
}

// Animate die
function animateDieWithText(text){
    const die=document.getElementById('die');
    die.classList.remove('rolling'); void die.offsetWidth;
    die.classList.add('rolling');
    dieText.innerText=text;
    setTimeout(()=>die.classList.remove('rolling'),900);
}

// Trigger effect
function triggerEffect(effect){
    const x=Math.random();
    const y=Math.random();

    // coordinate in pixel
    const px = x * window.innerWidth;
    const py = y * window.innerHeight;

    switch(effect){
        case 'confetti':
            confetti({ particleCount:60, spread:70, origin:{x,y} });
            break;
        case 'fireworks':
            confetti({ particleCount:100, spread:160, origin:{x,y}, colors:['#ff0000','#ffff00','#00ff00','#00ffff','#ff00ff'], shapes:['square','circle'] });
            break;
        case 'stars':
            // particelle emoji stellina
            for(let i=0;i<30;i++){
                createEmojiParticle('✨', px, py);
            }
            break;
        case 'sparkles':
            for(let i=0;i<40;i++){
                createEmojiParticle('💫', px, py);
            }
            break;
        case 'bubbles':
            for(let i=0;i<30;i++){
                createEmojiParticle('⚪', px, py);
            }
            break;
        case 'ribbons':
            for(let i=0;i<30;i++){
                createRibbon(px, py);
            }
            break;
        case 'smoke':
            for(let i=0;i<30;i++){
                createEmojiParticle('💨', px, py);
            }
            break;
        case 'hearts':
            for(let i=0;i<30;i++){
                createEmojiParticle('❤️', px, py);
            }
            break;
    }
}

// funzione generica per emoji
function createEmojiParticle(emoji){
    // Genera posizione iniziale random su quasi tutto lo schermo
    const startX = Math.random() * window.innerWidth;
    const startY = Math.random() * window.innerHeight * 0.6; // parte superiore dello schermo
    const el = document.createElement('div');
    el.innerText = emoji;
    el.style.position = 'fixed';
    el.style.left = startX + 'px';
    el.style.top = startY + 'px';
    el.style.fontSize = (12 + Math.random()*18) + 'px';
    el.style.pointerEvents = 'none';
    el.style.opacity = 1;
    el.style.transition = 'all 2.5s ease-out';
    document.body.appendChild(el);

    // Muovi la particella in direzione random
    const deltaX = (Math.random()-0.5) * 400; // spostamento orizzontale
    const deltaY = 150 + Math.random()*200;   // spostamento verticale
    setTimeout(()=>{
        el.style.top = (startY + deltaY) + 'px';
        el.style.left = (startX + deltaX) + 'px';
        el.style.opacity = 0;
    },50);

    setTimeout(()=>el.remove(),2600);
}

function createRibbon(){
    const startX = Math.random() * window.innerWidth;
    const startY = Math.random() * window.innerHeight * 0.5;
    const el = document.createElement('div');
    el.style.position = 'fixed';
    el.style.left = startX + 'px';
    el.style.top = startY + 'px';
    el.style.width = '6px';
    el.style.height = '30px';
    el.style.backgroundColor = randomColor();
    el.style.borderRadius = '3px';
    el.style.transform = 'rotate('+Math.random()*360+'deg)';
    el.style.opacity = 1;
    el.style.transition = 'all 2.5s ease-out';
    document.body.appendChild(el);

    const deltaX = (Math.random()-0.5)*400;
    const deltaY = 150 + Math.random()*200;
    setTimeout(()=>{
        el.style.top = (startY + deltaY) + 'px';
        el.style.left = (startX + deltaX) + 'px';
        el.style.opacity = 0;
    },50);

    setTimeout(()=>el.remove(),2600);
}

function randomColor(){
    const colors=['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];
    return colors[Math.floor(Math.random()*colors.length)];
}


// Roll die
rollBtn.addEventListener('click',()=>{
    if(faces.length===0) return alert('Aggiungi prima almeno una faccia.');
    const idx=Math.floor(Math.random()*faces.length); const face=faces[idx];
    animateDieWithText((questionInput.value||'A chi tocca?')+" → "+(face.emoji||'')+face.name);
    stats.total=(stats.total||0)+1;
    stats.counts[face.name]=(stats.counts[face.name]||0)+1;
    totalDrawsEl.innerText=stats.total;
    lastDrawEl.innerText=face.name;
    saveStats();
    updateChart();
    triggerEffect(face.effect||'confetti');
});

// Add/modify face
addFaceBtn.addEventListener('click',()=>{
    document.getElementById('faceId').value='';
    document.getElementById('faceForm').reset();
    faceModal.show();
});

saveFaceBtn.addEventListener('click',()=>{
    const id=document.getElementById('faceId').value;
    const name=document.getElementById('faceName').value.trim();
    const emoji=document.getElementById('faceEmoji').value.trim();
    const color=document.getElementById('faceColor').value;
    const effect=document.getElementById('faceEffect').value;
    if(!name){ alert('Inserisci un nome'); return; }
    if(faces.find(f=>f.name.toLowerCase()===name.toLowerCase() && id==='')){ alert('Questa faccia esiste già'); return; }
    const obj={ name, emoji, color, effect };
    if(id===''){ faces.push(obj); } else { faces[Number(id)]=obj; }
    saveFaces(); renderFaces(); updateChart(); faceModal.hide();
});

// Update question
questionInput.addEventListener('input',saveQuestion);

// Theme
function applyTheme(){
    document.body.className=''; 
    if(settings.theme) document.body.classList.add(settings.theme);
    document.querySelectorAll('.btn-custom').forEach(btn=>{
        btn.style.background=getComputedStyle(document.body).getPropertyValue('--btn-bg');
    });
}
themeSelect.addEventListener('change',()=>{
    settings.theme=themeSelect.value;
    applyTheme();
    saveSettings();
});

// Stats UI
function updateStatsUI(){ totalDrawsEl.innerText=stats.total||0; lastDrawEl.innerText=stats.last||'—'; }

// Chart.js
function initChart(){
    statsChart=new Chart(statsChartCtx,{
        type:'bar',
        data:{
            labels:[],
            datasets:[{ label:'Estrazioni', data:[], backgroundColor:[], borderColor:[], borderWidth:1 }]
        },
        options:{
            responsive:true,
            plugins:{ legend:{ display:false } },
            scales:{ y:{ beginAtZero:true } }
        }
    });
    updateChart();
}

function updateChart(){
    if(!statsChart) return;
    statsChart.data.labels=faces.map(f=>f.name);
    statsChart.data.datasets[0].data=faces.map(f=>stats.counts[f.name]||0);
    statsChart.data.datasets[0].backgroundColor=faces.map(f=>f.color);
    statsChart.data.datasets[0].borderColor=faces.map(()=> '#000');
    statsChart.update();
}

// Utility: contrast color
function getContrastColor(hex){
    if(!hex) return '#000';
    const c=hex.substring(1);
    const r=parseInt(c.substr(0,2),16);
    const g=parseInt(c.substr(2,2),16);
    const b=parseInt(c.substr(4,2),16);
    const yiq=((r*299)+(g*587)+(b*114))/1000;
    return (yiq>=128)?'#111':'#fff';
}

// Initialize
load();
</script>

</body>
</html>
